<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>Web_Security_lab1 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-10-02 16:35">
      2020年10月2日 下午
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      48
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="Packet-Sniffing-lab"><a href="#Packet-Sniffing-lab" class="headerlink" title="Packet Sniffing lab"></a>Packet Sniffing lab</h1><p>[TOC]</p>
<h3 id="Task-1-1-Sniffing-Packets"><a href="#Task-1-1-Sniffing-Packets" class="headerlink" title="Task 1.1: Sniffing Packets"></a>Task 1.1: Sniffing Packets</h3><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span>

<span class="hljs-keyword">from</span> scapy.all <span class="hljs-keyword">import</span> *

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_pkt</span><span class="hljs-params">(pkt)</span>:</span>
	pkt.show()

pkt = sniff(filter=<span class="hljs-string">'icmp'</span>,prn=print_pkt)</code></pre>

<p>运行截图</p>
<p><img src="/2020/10/02/Web-Security-lab1/task1.1A.PNG" srcset="/img/loading.gif" alt="task1.1A"></p>
<p>打开wireshark，进行抓包</p>
<p><img src="/2020/10/02/Web-Security-lab1/task1.1A_1.PNG" srcset="/img/loading.gif" alt="task1.1A_1"></p>
<p>发现确实抓到了数据包</p>
<p>之后我们如果不用root权限的话，直接./sniffer.py进行运行，此时</p>
<p><img src="/2020/10/02/Web-Security-lab1/task1.1.PNG" srcset="/img/loading.gif" alt="task1.1"></p>
<p>抓取ICMP的包</p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span>

<span class="hljs-keyword">from</span> scapy.all <span class="hljs-keyword">import</span> *

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_pkt</span><span class="hljs-params">(pkt)</span>:</span>
	pkt.show()

pkt = sniff(filter=<span class="hljs-string">'icmp'</span>,prn=print_pkt)</code></pre>

<p>抓取对应主机以及端口的数据包</p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span>

<span class="hljs-keyword">from</span> scapy.all <span class="hljs-keyword">import</span> *

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_pkt</span><span class="hljs-params">(pkt)</span>:</span>
	pkt.show()

pkt = sniff(filter=<span class="hljs-string">'src host 182.61.200.6 and dst port 23'</span>,prn=print_pkt)</code></pre>

<p>抓取对应子网的包</p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span>

<span class="hljs-keyword">from</span> scapy.all <span class="hljs-keyword">import</span> *

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_pkt</span><span class="hljs-params">(pkt)</span>:</span>
	pkt.show()

pkt = sniff(filter=<span class="hljs-string">'host 128.230.0.0/16'</span>,prn=print_pkt)</code></pre>

<h3 id="Task-1-2-Spoofing-ICMP-Packets"><a href="#Task-1-2-Spoofing-ICMP-Packets" class="headerlink" title="Task 1.2: Spoofing ICMP Packets"></a>Task 1.2: Spoofing ICMP Packets</h3><pre><code class="hljs ruby"><span class="hljs-meta">&gt;&gt;</span>&gt; from scapy.all import *
<span class="hljs-meta">&gt;&gt;</span>&gt; a = IP() 
<span class="hljs-meta">&gt;&gt;</span>&gt; a.src = ’<span class="hljs-number">10.0</span>.<span class="hljs-number">2.3</span>’ 
<span class="hljs-meta">&gt;&gt;</span>&gt; b = ICMP() 
<span class="hljs-meta">&gt;&gt;</span>&gt; p = a/b 
<span class="hljs-meta">&gt;&gt;</span>&gt; send(p)</code></pre>

<p>在原来的code基础上将a.dst改为a.src就可以伪造任意分配的IP源地址，此时运行ls（a），会出现：</p>
<pre><code class="hljs yaml"><span class="hljs-string">&gt;&gt;&gt;</span> <span class="hljs-string">ls(a)</span>
<span class="hljs-attr">version    :</span> <span class="hljs-string">BitField</span>  <span class="hljs-string">(4</span> <span class="hljs-string">bits)</span>                  <span class="hljs-string">=</span> <span class="hljs-number">4</span>               <span class="hljs-string">(4)</span>
<span class="hljs-attr">ihl        :</span> <span class="hljs-string">BitField</span>  <span class="hljs-string">(4</span> <span class="hljs-string">bits)</span>                  <span class="hljs-string">=</span> <span class="hljs-string">None</span>            <span class="hljs-string">(None)</span>
<span class="hljs-attr">tos        :</span> <span class="hljs-string">XByteField</span>                          <span class="hljs-string">=</span> <span class="hljs-number">0</span>               <span class="hljs-string">(0)</span>
<span class="hljs-attr">len        :</span> <span class="hljs-string">ShortField</span>                          <span class="hljs-string">=</span> <span class="hljs-string">None</span>            <span class="hljs-string">(None)</span>
<span class="hljs-attr">id         :</span> <span class="hljs-string">ShortField</span>                          <span class="hljs-string">=</span> <span class="hljs-number">1</span>               <span class="hljs-string">(1)</span>
<span class="hljs-attr">flags      :</span> <span class="hljs-string">FlagsField</span>  <span class="hljs-string">(3</span> <span class="hljs-string">bits)</span>                <span class="hljs-string">=</span> <span class="hljs-string">&lt;Flag</span> <span class="hljs-number">0</span> <span class="hljs-string">()&gt;</span>     <span class="hljs-string">(&lt;Flag</span> <span class="hljs-number">0</span> <span class="hljs-string">()&gt;)</span>
<span class="hljs-attr">frag       :</span> <span class="hljs-string">BitField</span>  <span class="hljs-string">(13</span> <span class="hljs-string">bits)</span>                 <span class="hljs-string">=</span> <span class="hljs-number">0</span>               <span class="hljs-string">(0)</span>
<span class="hljs-attr">ttl        :</span> <span class="hljs-string">ByteField</span>                           <span class="hljs-string">=</span> <span class="hljs-number">64</span>              <span class="hljs-string">(64)</span>
<span class="hljs-attr">proto      :</span> <span class="hljs-string">ByteEnumField</span>                       <span class="hljs-string">=</span> <span class="hljs-number">0</span>               <span class="hljs-string">(0)</span>
<span class="hljs-attr">chksum     :</span> <span class="hljs-string">XShortField</span>                         <span class="hljs-string">=</span> <span class="hljs-string">None</span>            <span class="hljs-string">(None)</span>
<span class="hljs-attr">src        :</span> <span class="hljs-string">SourceIPField</span>                       <span class="hljs-string">=</span> <span class="hljs-string">'10.0.2.3'</span>      <span class="hljs-string">(None)</span>
<span class="hljs-attr">dst        :</span> <span class="hljs-string">DestIPField</span>                         <span class="hljs-string">=</span> <span class="hljs-string">'127.0.0.1'</span>     <span class="hljs-string">(None)</span>
<span class="hljs-attr">options    :</span> <span class="hljs-string">PacketListField</span>                     <span class="hljs-string">=</span> <span class="hljs-string">[]</span>              <span class="hljs-string">([])</span></code></pre>

<h3 id="Task-1-3-Traceroute"><a href="#Task-1-3-Traceroute" class="headerlink" title="Task 1.3: Traceroute"></a>Task 1.3: Traceroute</h3><p>提供的code</p>
<pre><code class="hljs ruby"><span class="hljs-meta">&gt;&gt;</span>&gt; a = IP()
<span class="hljs-meta">&gt;&gt;</span>&gt; a.dst = ’<span class="hljs-number">1.2</span>.<span class="hljs-number">3.4</span>’
<span class="hljs-meta">&gt;&gt;</span>&gt; a.ttl = <span class="hljs-number">3</span>
<span class="hljs-meta">&gt;&gt;</span>&gt; b = ICMP()
<span class="hljs-meta">&gt;&gt;</span>&gt; send(a/b)</code></pre>

<p>在这一步中可以采用笨方法，直接是一个一个修改TTL</p>
<p>同时，在这一步中，由于之前对于ICMP协议的一些东西忘记，参考了一些博文，mark一下</p>
<p><a href="https://blog.csdn.net/qq_35733751/article/details/80053091?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522160181088219195246651245%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=160181088219195246651245&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v28-1-80053091.pc_first_rank_v2_rank_v28&utm_term=icmp%E8%B6%85%E6%97%B6%E6%8A%A5%E6%96%87&spm=1018.2118.3001.4187" target="_blank" rel="noopener">ICMP差错报告报文</a></p>
<pre><code class="hljs livecodeserver"><span class="hljs-comment">#!/usr/bin/python3</span>

<span class="hljs-built_in">from</span> scapy.all import *

<span class="hljs-keyword">a</span> = IP()
<span class="hljs-keyword">a</span>.dst = <span class="hljs-string">'1.2.3.4'</span>
<span class="hljs-keyword">a</span>.ttl = <span class="hljs-number">10</span>
b = ICMP()
<span class="hljs-keyword">while</span> <span class="hljs-keyword">a</span>.ttl &gt;= <span class="hljs-number">0</span>:
	<span class="hljs-keyword">a</span>.ttl = <span class="hljs-keyword">a</span>.ttl - <span class="hljs-number">1</span>
	<span class="hljs-built_in">send</span>(<span class="hljs-keyword">a</span>/b)</code></pre>

<p>之后在terminal和wireshark里面分别运行以及抓包</p>
<p><img src="/2020/10/02/Web-Security-lab1/task1.4.PNG" srcset="/img/loading.gif" alt="task1.4"></p>
<p><img src="/2020/10/02/Web-Security-lab1/task1.4.2.PNG" srcset="/img/loading.gif" alt="task1.4.2"></p>
<p>可以看到发送成功，并且ttl发生变化</p>
<h3 id="Task-1-4-Sniffing-and-then-Spoofing"><a href="#Task-1-4-Sniffing-and-then-Spoofing" class="headerlink" title="Task 1.4: Sniffing and-then Spoofing"></a>Task 1.4: Sniffing and-then Spoofing</h3><p>在这里，这个task的具体要求是：</p>
<ol>
<li>VM A要去ping一个IP为X的端系统，但是不知道X是否是alive状态，并且我们通过在VM A上的wireshark可以来截取包</li>
<li>VM B来对于所有数据包进行嗅探，当它发现目的IP为X的数据包的时候，利用spoofing来伪造一个IP为X的response报文</li>
</ol>
<p>在这里我选择让A去ping百度的IP地址，即X为182.61.200.6，所以在B中的sniffing&amp;spoofing的code如下：（A是10.0.2.4；B是10.0.2.6）</p>
<pre><code class="hljs livecodeserver"><span class="hljs-comment">#!/usr/bin/python</span>
<span class="hljs-built_in">from</span> scapy.all import *
def spoof_pkt(pkt):
    <span class="hljs-keyword">a</span> = IP() 
    b = ICMP()  
    <span class="hljs-keyword">a</span>.dst = <span class="hljs-string">'10.0.2.4'</span>
    <span class="hljs-keyword">a</span>.src = <span class="hljs-string">'182.61.200.6'</span>
    <span class="hljs-built_in">send</span>(<span class="hljs-keyword">a</span> / b) 

pkt = sniff(<span class="hljs-built_in">filter</span>=<span class="hljs-string">'icmp and host 10.0.2.4'</span>, prn=spoof_pkt)</code></pre>

<p>修改权限并运行py文件，在测试的时候我为了能够看出是否是B发送过来的，就没有把src的IP进行修改，即没写a.src那一行</p>
<p>之后在B机器上运行wireshark来获取包的内容</p>
<p><img src="/2020/10/02/Web-Security-lab1/lab1_task1.4.PNG" srcset="/img/loading.gif" alt="lab1_task1.4"></p>
<p>可以看到在没有spoofing的数据包中，仅仅是将数据包返回，通过测试</p>
<p>整个运行后：</p>
<p><img src="/2020/10/02/Web-Security-lab1/lab1_task1.4_2.PNG" srcset="/img/loading.gif" alt="lab1_task1.4_2"></p>
<p>完成！！！</p>
<h2 id="Task-Set-2-Writing-Programs-to-Sniff-and-Spoof-Packets"><a href="#Task-Set-2-Writing-Programs-to-Sniff-and-Spoof-Packets" class="headerlink" title="Task Set 2: Writing Programs to Sniff and Spoof Packets"></a>Task Set 2: Writing Programs to Sniff and Spoof Packets</h2><h3 id="Task-2-1-Writing-Packet-Sniffing-Program"><a href="#Task-2-1-Writing-Packet-Sniffing-Program" class="headerlink" title="Task 2.1: Writing Packet Sniffing Program"></a>Task 2.1: Writing Packet Sniffing Program</h3><p>将给出的code试运行并且进行分析后，先来看需要回答的问题</p>
<ol>
<li><p>Q：Please use your own words to describe the sequence of the library calls that are essential for sniffer programs. This is meant to be a summary, not detailed explanation like the one in the tutorial or book.</p>
<p> A：第一步，配置机器</p>
<blockquote>
<p>在这一步中，我们首先需要的是知道我们所要sniff on的接口的名称，在sample code中，我们采用的是pacp_lookupdev函数来进行自动获取</p>
</blockquote>
<p> ​      第二步，打开设备来进行嗅探</p>
<blockquote>
<p>在第二部的时候，我们需要创建一个嗅探会话，通过使用pcap_open_live来进行使用，其中第一个参数表示我们刚刚打开的设备的接口名称，第二个表示我们能够读取的最大字数，第三个表示模式（混杂模式置为true，非混杂置为false），to_ms表示读取超时，以毫秒为单位，最后的可作为错误信息的存储</p>
</blockquote>
<p> ​      第三步，过滤流量</p>
<blockquote>
<p>我们并不是对于所有端口的流量都感兴趣，通常情况下，只关心特定端口的流量情况，在这一步我们分为了两个步骤，首先是对于过滤器的“compile”过程，使用的是pcap_compile函数，这个函数返回值为-1时表示false，其他都表示成功</p>
<p>接下来我们要进行的时对于过滤器的应用，是pcap_setfilter函数</p>
</blockquote>
<p> ​      第四步，实际嗅探</p>
<blockquote>
<p>在这里，有两种进行获取数据包的方式，一种是利用pcap_next（）但是缺点是没有办法进行批量处理，另一种的是利用回调函数，回调函数就是每次我都会进行一个调用的函数，比如在等待用户在键盘上输入一个字符，之后我需要调用一个函数，这个函数定义了要执行的操作，之后一般我们采用pcap_loop()函数来进行抓包</p>
</blockquote>
<p> ​      第五步，关闭会话</p>
</li>
</ol>
<p>之后在写完并且试运行sniff的code，下面是我所获取的结果</p>
<p><img src="/2020/10/02/Web-Security-lab1/lab1_task2.1A.PNG" srcset="/img/loading.gif" alt="lab1_task2.1A"></p>
<p>其中我们可以在From和To的后面来获得对应的IP地址，同时如果不给予root权限就进行运行，会出现segmentation fault</p>
<p><img src="/2020/10/02/Web-Security-lab1/lab1_task2.1A_2.PNG" srcset="/img/loading.gif" alt="lab1_task2.1A_2"></p>
<ol start="2">
<li><p>Q：Why do you need the root privilege to run a sniffer program? Where does the program fail if it is executed without the root privilege?</p>
<p> A：因为我们需要root权限来打开一个sniffing会话，会卡在pcap_open_live（）这里</p>
</li>
<li><p>Q：Please turn on and turn off the promiscuous mode in your sniffer program. Can you demonstrate the difference when this mode is on and off? Please describe how you can demonstrate this.</p>
<p> A：首先是打开（即混杂模式为true）的状态</p>
<p> <img src="/2020/10/02/Web-Security-lab1/task2.1_3.PNG" srcset="/img/loading.gif" alt="task2.1_3"></p>
<p> 此时可以看到即便发出ping命令的并不是这台虚拟机，但是由于sniff的VM和发出ping的VM在一个网络中，仍然会收到数据包（），但是如果将混杂模式参数置为0，那么就只会接收到sniff的VM的收和发的数据包，而不会接收pass through的数据包</p>
<p> <img src="/2020/10/02/Web-Security-lab1/task2.1_3_3.PNG" srcset="/img/loading.gif" alt="task2.1_3_3"></p>
<p> <img src="/2020/10/02/Web-Security-lab1/task2.1_3_2.PNG" srcset="/img/loading.gif" alt="task2.1_3_2"></p>
<h4 id="Task-2-1B-Writing-Filters"><a href="#Task-2-1B-Writing-Filters" class="headerlink" title="Task 2.1B: Writing Filters"></a>Task 2.1B: Writing Filters</h4><ol>
<li><p>首先是ICMP的数据包，将filter_exp进行修改即可</p>
<p> <img src="/2020/10/02/Web-Security-lab1/task2.1_4.PNG" srcset="/img/loading.gif" alt="task2.1_4"></p>
<p>​    编译后进行运行，并且在10.0.2.6这台VM上ping 10.0.2.4</p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.1_4_2.PNG" srcset="/img/loading.gif" alt="task2.1_4_2"></p>
</li>
<li><p>其次是捕获tcp包</p>
<p> <img src="/2020/10/02/Web-Security-lab1/task2.1B.PNG" srcset="/img/loading.gif" alt="task2.1B"></p>
<p>​    </p>
<p>​        之后编译运行，在另一台VM上运行talnet <a href="http://www.baidu.com命令" target="_blank" rel="noopener">www.baidu.com命令</a></p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.1_b_2.PNG" srcset="/img/loading.gif" alt="task2.1_b_2"></p>
<h4 id="Task-2-1C-Sniffing-Passwords"><a href="#Task-2-1C-Sniffing-Passwords" class="headerlink" title="Task 2.1C: Sniffing Passwords."></a>Task 2.1C: Sniffing Passwords.</h4><p><img src="/2020/10/02/Web-Security-lab1/task2.1_c.PNG" srcset="/img/loading.gif" alt="task2.1_c"></p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.1_c_2.PNG" srcset="/img/loading.gif" alt="task2.1_c_2"></p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.1_c_3.PNG" srcset="/img/loading.gif" alt="task2.1_c_3"></p>
<p>受篇幅所限，打印出来的完整password是dees</p>
</li>
</ol>
</li>
</ol>
<h3 id="Task-2-2-Spoofing"><a href="#Task-2-2-Spoofing" class="headerlink" title="Task 2.2: Spoofing"></a>Task 2.2: Spoofing</h3><p><img src="/2020/10/02/Web-Security-lab1/task2.2_2.PNG" srcset="/img/loading.gif" alt="task2.2_2"></p>
<p>运行截图：</p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.2_1.PNG" srcset="/img/loading.gif" alt="task2.2_1"></p>
<h4 id="Task-2-2B-Spoof-an-ICMP-Echo-Request"><a href="#Task-2-2B-Spoof-an-ICMP-Echo-Request" class="headerlink" title="Task 2.2B: Spoof an ICMP Echo Request."></a>Task 2.2B: Spoof an ICMP Echo Request.</h4><p>之后依旧采用这个方法，来对ICMP进行构造，通过第一次运行并用wireshark来进行看ICMP的checksum的值，修改后再次进行运行，可以得到echo reply</p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.2_3.PNG" srcset="/img/loading.gif" alt="task2.2_3">)<img src="/2020/10/02/Web-Security-lab1/task2.2-4.PNG" srcset="/img/loading.gif" alt="task2.2-4"></p>
<p>下面对于问题进行回答</p>
<ol start="4">
<li><p>Q:Can you set the IP packet length field to an arbitrary value, regardless of how big the actual packet is?</p>
<p> A:经过实验，可以发现当我们修改IP首部长度的时候，会在wireshark里面显示错误，但是如果是修改数据包长度的话，在wireshark并没有出现报错</p>
</li>
<li><p>Q:Using the raw socket programming, do you have to calculate the checksum for the IP header?</p>
<p> A:并不需要计算IP头部的首部校验和，因为在IP头部上TTL可能会发生改变，此时校验和也会随之发生改变</p>
</li>
<li><p>Q:Why do you need the root privilege to run the programs that use raw sockets? Where does the program fail if executed without the root privilege?</p>
</li>
</ol>
<h3 id="Task-2-3-Sniff-and-then-Spoof"><a href="#Task-2-3-Sniff-and-then-Spoof" class="headerlink" title="Task 2.3: Sniff and then Spoof"></a>Task 2.3: Sniff and then Spoof</h3><p>要求：VM A要ping X，这个会产生一个ICMP的echo request报文，之后在VM B上面运行sniff_spoof程序，来检测此时的网络，当它sniff到一个echo request 报文之后，无论报文的的目的IP是什么，都立刻进行伪造一个echo reply报文，其中，echo reply报文的目的IP为A的IP，源IP为X的IP</p>
<p>下面是sniff_and_spoof.c的code</p>
<pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pcap.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ctype.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>

<span class="hljs-comment">/* Ethernet addresses are 6 bytes */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ETHER_ADDR_LEN	6</span>

<span class="hljs-comment">/* Ethernet header */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sniff_ethernet</span> &#123;</span>
        u_char  ether_dhost[ETHER_ADDR_LEN];    <span class="hljs-comment">/* destination host address */</span>
        u_char  ether_shost[ETHER_ADDR_LEN];    <span class="hljs-comment">/* source host address */</span>
        u_short ether_type;                     <span class="hljs-comment">/* IP? ARP? RARP? etc */</span>
&#125;;

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sniff_ip</span> &#123;</span>
        u_char  ip_vhl;                 <span class="hljs-comment">/* version &lt;&lt; 4 | header length &gt;&gt; 2 */</span>
        u_char  ip_tos;                 <span class="hljs-comment">/* type of service */</span>
        u_short ip_len;                 <span class="hljs-comment">/* total length */</span>
        u_short ip_id;                  <span class="hljs-comment">/* identification */</span>
        u_short ip_off;                 <span class="hljs-comment">/* fragment offset field */</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IP_RF 0x8000            <span class="hljs-comment">/* reserved fragment flag */</span></span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IP_DF 0x4000            <span class="hljs-comment">/* dont fragment flag */</span></span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IP_MF 0x2000            <span class="hljs-comment">/* more fragments flag */</span></span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IP_OFFMASK 0x1fff       <span class="hljs-comment">/* mask for fragmenting bits */</span></span>
        u_char  ip_ttl;                 <span class="hljs-comment">/* time to live */</span>
        u_char  ip_p;                   <span class="hljs-comment">/* protocol */</span>
        u_short ip_sum;                 <span class="hljs-comment">/* checksum */</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span>  <span class="hljs-title">in_addr</span> <span class="hljs-title">ip_src</span>,<span class="hljs-title">ip_dst</span>;</span>  <span class="hljs-comment">/* source and dest address */</span>
&#125;;
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IP_HL(ip)               (((ip)-&gt;ip_vhl) &amp; 0x0f)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IP_V(ip)                (((ip)-&gt;ip_vhl) &gt;&gt; 4)</span>

<span class="hljs-comment">/* TCP header */</span>
<span class="hljs-keyword">typedef</span> u_int tcp_seq;

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sniff_tcp</span> &#123;</span>
        u_short th_sport;               <span class="hljs-comment">/* source port */</span>
        u_short th_dport;               <span class="hljs-comment">/* destination port */</span>
        tcp_seq th_seq;                 <span class="hljs-comment">/* sequence number */</span>
        tcp_seq th_ack;                 <span class="hljs-comment">/* acknowledgement number */</span>
        u_char  th_offx2;               <span class="hljs-comment">/* data offset, rsvd */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_OFF(th)      (((th)-&gt;th_offx2 &amp; 0xf0) &gt;&gt; 4)</span>
        u_char  th_flags;
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_FIN  0x01</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_SYN  0x02</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_RST  0x04</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_PUSH 0x08</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_ACK  0x10</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_URG  0x20</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_ECE  0x40</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_CWR  0x80</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TH_FLAGS        (TH_FIN|TH_SYN|TH_RST|TH_ACK|TH_URG|TH_ECE|TH_CWR)</span>
        u_short th_win;                 <span class="hljs-comment">/* window */</span>
        u_short th_sum;                 <span class="hljs-comment">/* checksum */</span>
        u_short th_urp;                 <span class="hljs-comment">/* urgent pointer */</span>
&#125;;

<span class="hljs-comment">/* ethernet headers are always exactly 14 bytes */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE_ETHERNET 14</span>

	<span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sniff_ethernet</span> *<span class="hljs-title">ethernet</span>;</span> <span class="hljs-comment">/* The ethernet header */</span>
	<span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sniff_ip</span> *<span class="hljs-title">ip</span>;</span> <span class="hljs-comment">/* The IP header */</span>
	<span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sniff_tcp</span> *<span class="hljs-title">tcp</span>;</span> <span class="hljs-comment">/* The TCP header */</span>
	<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *payload; <span class="hljs-comment">/* Packet payload */</span>

	u_int size_ip;
	u_int size_tcp;
    u_int size_payload;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">insertip</span><span class="hljs-params">(struct in_addr addrip, <span class="hljs-keyword">char</span> *<span class="hljs-built_in">buffer</span>, <span class="hljs-keyword">int</span> addr)</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">char</span> *ip;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> intip;
    <span class="hljs-built_in">memcpy</span>(&amp;intip, &amp;addrip, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>));
    <span class="hljs-keyword">int</span> a = (intip &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>;
    <span class="hljs-keyword">int</span> b = (intip &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>;
    <span class="hljs-keyword">int</span> c = (intip &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>;
    <span class="hljs-keyword">int</span> d = intip &amp; <span class="hljs-number">0xff</span>;
    <span class="hljs-keyword">char</span> a1 = a;
    <span class="hljs-keyword">char</span> b1 = b;
    <span class="hljs-keyword">char</span> c1 = c;
    <span class="hljs-keyword">char</span> d1 = d;
    <span class="hljs-built_in">strncpy</span>(&amp;<span class="hljs-built_in">buffer</span>[addr], &amp;d1, <span class="hljs-number">1</span>);
    <span class="hljs-built_in">strncpy</span>(&amp;<span class="hljs-built_in">buffer</span>[addr + <span class="hljs-number">1</span>], &amp;c1, <span class="hljs-number">1</span>);
    <span class="hljs-built_in">strncpy</span>(&amp;<span class="hljs-built_in">buffer</span>[addr + <span class="hljs-number">2</span>], &amp;b1, <span class="hljs-number">1</span>);
    <span class="hljs-built_in">strncpy</span>(&amp;<span class="hljs-built_in">buffer</span>[addr + <span class="hljs-number">3</span>], &amp;a1, <span class="hljs-number">1</span>);
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print_hex_ascii_line</span><span class="hljs-params">(<span class="hljs-keyword">const</span> u_char *payload, <span class="hljs-keyword">int</span> len, <span class="hljs-keyword">int</span> offset)</span></span>
<span class="hljs-function"></span>&#123;

	<span class="hljs-keyword">int</span> i;
	<span class="hljs-keyword">int</span> gap;
	<span class="hljs-keyword">const</span> u_char *ch;

	<span class="hljs-comment">/* offset */</span>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%05d   "</span>, offset);
	
	<span class="hljs-comment">/* hex */</span>
	ch = payload;
	<span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%02x "</span>, *ch);
		ch++;
		<span class="hljs-comment">/* print extra space after 8th byte for visual aid */</span>
		<span class="hljs-keyword">if</span> (i == <span class="hljs-number">7</span>)
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">" "</span>);
	&#125;
	<span class="hljs-comment">/* print space to handle line less than 8 bytes */</span>
	<span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">8</span>)
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">" "</span>);
	
	<span class="hljs-comment">/* fill hex gap with spaces if not full line */</span>
	<span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">16</span>) &#123;
		gap = <span class="hljs-number">16</span> - len;
		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; gap; i++) &#123;
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"   "</span>);
		&#125;
	&#125;
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"   "</span>);
	
	<span class="hljs-comment">/* ascii (if printable) */</span>
	ch = payload;
	<span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;
		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isprint</span>(*ch))
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%c"</span>, *ch);
		<span class="hljs-keyword">else</span>
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"."</span>);
		ch++;
	&#125;

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-keyword">return</span>;
&#125;

<span class="hljs-comment">/*</span>
<span class="hljs-comment"> * print packet payload data (avoid printing binary data)</span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print_payload</span><span class="hljs-params">(<span class="hljs-keyword">const</span> u_char *payload, <span class="hljs-keyword">int</span> len)</span></span>
<span class="hljs-function"></span>&#123;

	<span class="hljs-keyword">int</span> len_rem = len;
	<span class="hljs-keyword">int</span> line_width = <span class="hljs-number">16</span>;			<span class="hljs-comment">/* number of bytes per line */</span>
	<span class="hljs-keyword">int</span> line_len;
	<span class="hljs-keyword">int</span> offset = <span class="hljs-number">0</span>;					<span class="hljs-comment">/* zero-based offset counter */</span>
	<span class="hljs-keyword">const</span> u_char *ch = payload;

	<span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>)
		<span class="hljs-keyword">return</span>;

	<span class="hljs-comment">/* data fits on one line */</span>
	<span class="hljs-keyword">if</span> (len &lt;= line_width) &#123;
		print_hex_ascii_line(ch, len, offset);
		<span class="hljs-keyword">return</span>;
	&#125;

	<span class="hljs-comment">/* data spans multiple lines */</span>
	<span class="hljs-keyword">for</span> ( ;; ) &#123;
		<span class="hljs-comment">/* compute current line length */</span>
		line_len = line_width % len_rem;
		<span class="hljs-comment">/* print line */</span>
		print_hex_ascii_line(ch, line_len, offset);
		<span class="hljs-comment">/* compute total remaining */</span>
		len_rem = len_rem - line_len;
		<span class="hljs-comment">/* shift pointer to remaining bytes to print */</span>
		ch = ch + line_len;
		<span class="hljs-comment">/* add offset */</span>
		offset = offset + line_width;
		<span class="hljs-comment">/* check if we have line width chars or less */</span>
		<span class="hljs-keyword">if</span> (len_rem &lt;= line_width) &#123;
			<span class="hljs-comment">/* print last line and get out */</span>
			print_hex_ascii_line(ch, len_rem, offset);
			<span class="hljs-keyword">break</span>;
		&#125;
	&#125;

    <span class="hljs-keyword">return</span>;
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">got_packet</span><span class="hljs-params">(u_char *args, <span class="hljs-keyword">const</span> struct pcap_pkthdr *header, <span class="hljs-keyword">const</span> u_char *packet)</span></span>
<span class="hljs-function"></span>&#123;
    ethernet = (struct sniff_ethernet *)(packet);
    ip = (struct sniff_ip*)(packet + SIZE_ETHERNET);
    <span class="hljs-keyword">char</span>* src = inet_ntoa(ip-&gt;ip_src);
    <span class="hljs-keyword">char</span>* dst = inet_ntoa(ip-&gt;ip_dst);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"got a icmp request packet src addr: %s\n"</span>, inet_ntoa(ip-&gt;ip_src)); 
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"dst addr :%s\nsend a reply \n"</span>, inet_ntoa(ip-&gt;ip_dst));
    <span class="hljs-keyword">int</span> sd;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span>
    sd = socket(AF_INET, SOCK_RAW, IPPROTO_RAW); 

    <span class="hljs-keyword">if</span>(sd &lt; <span class="hljs-number">0</span>) 
    &#123;
        perror(<span class="hljs-string">"socket() error"</span>); 
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
    &#125;
    <span class="hljs-built_in">sin</span>.sin_family = AF_INET;

    <span class="hljs-keyword">char</span> <span class="hljs-built_in">buffer</span>[<span class="hljs-number">1024</span>] = &#123;
        <span class="hljs-comment">//ip</span>
        <span class="hljs-number">0x45</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x1c</span>,
        <span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,
        <span class="hljs-number">0x80</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,

        <span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,
        <span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,
        <span class="hljs-comment">//icmp  </span>
        <span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xff</span>,
        <span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,
    &#125;;
    insertip(ip-&gt;ip_src,<span class="hljs-built_in">buffer</span>,<span class="hljs-number">16</span>);
    insertip(ip-&gt;ip_dst,<span class="hljs-built_in">buffer</span>,<span class="hljs-number">12</span>);
    <span class="hljs-keyword">if</span>(sendto(sd, <span class="hljs-built_in">buffer</span>, <span class="hljs-number">20</span>+<span class="hljs-number">8</span>, <span class="hljs-number">0</span>, (struct sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>)) &lt; <span class="hljs-number">0</span>) 
	&#123;
	    perror(<span class="hljs-string">"sendto() error"</span>); 
	    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
	&#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;

	<span class="hljs-keyword">char</span> *dev;			<span class="hljs-comment">/* capture device name */</span>
	<span class="hljs-keyword">char</span> errbuf[PCAP_ERRBUF_SIZE];		<span class="hljs-comment">/* error buffer */</span>
	<span class="hljs-keyword">pcap_t</span> *handle;				<span class="hljs-comment">/* packet capture handle */</span>

	<span class="hljs-keyword">char</span> filter_exp[] = <span class="hljs-string">"icmp and icmp[0] = 8"</span>;		<span class="hljs-comment">/* filter expression [3] */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_program</span> <span class="hljs-title">fp</span>;</span>			<span class="hljs-comment">/* compiled filter program (expression) */</span>
	bpf_u_int32 mask;			<span class="hljs-comment">/* subnet mask */</span>
	bpf_u_int32 net;			<span class="hljs-comment">/* ip */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pcap_pkthdr</span> <span class="hljs-title">header</span>;</span>
    <span class="hljs-keyword">const</span> u_char *packet;
    <span class="hljs-comment">/* find a capture device if not specified on command-line */</span>
	dev = pcap_lookupdev(errbuf);
	<span class="hljs-keyword">if</span> (dev == <span class="hljs-literal">NULL</span>) &#123;
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't find default device: %s\n"</span>,errbuf);
		<span class="hljs-keyword">return</span> (<span class="hljs-number">2</span>);
	&#125;
	
	<span class="hljs-comment">/* get network number and mask associated with capture device */</span>
	<span class="hljs-keyword">if</span> (pcap_lookupnet(dev, &amp;net, &amp;mask, errbuf) == <span class="hljs-number">-1</span>) &#123;
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't get netmask for device %s: %s\n"</span>, dev, errbuf);
		net = <span class="hljs-number">0</span>;
		mask = <span class="hljs-number">0</span>;
	&#125;

	<span class="hljs-comment">/* print capture info */</span>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Device: %s\n"</span>, dev);
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Filter expression: %s\n"</span>, filter_exp);

	<span class="hljs-comment">/* open capture device */</span>
	handle = pcap_open_live(dev, BUFSIZ, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, errbuf);
	<span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">NULL</span>) &#123;
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't open device %s: %s\n"</span>, dev, errbuf);
		<span class="hljs-keyword">return</span>(<span class="hljs-number">2</span>);
	&#125;

	<span class="hljs-comment">/* compile the filter expression */</span>
	<span class="hljs-keyword">if</span> (pcap_compile(handle, &amp;fp, filter_exp, <span class="hljs-number">0</span>, net) == <span class="hljs-number">-1</span>) &#123;
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't parse filter %s: %s\n"</span>,
		    filter_exp, pcap_geterr(handle));
		<span class="hljs-keyword">return</span>(<span class="hljs-number">2</span>);
	&#125;

	<span class="hljs-comment">/* apply the compiled filter */</span>
	<span class="hljs-keyword">if</span> (pcap_setfilter(handle, &amp;fp) == <span class="hljs-number">-1</span>) &#123;
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't install filter %s: %s\n"</span>,
		    filter_exp, pcap_geterr(handle));
		<span class="hljs-keyword">return</span>(<span class="hljs-number">2</span>);
	&#125;

	<span class="hljs-comment">/* now we can set our callback function */</span>
	pcap_loop(handle, <span class="hljs-number">-1</span>, got_packet, <span class="hljs-literal">NULL</span>);
	pcap_close(handle);

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nCapture complete.\n"</span>);

<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre>

<p>其中，一些数据结构来自于网站提供的sniffex.c,insertip（）函数的作用是将VM A发送的IP的源地址与目的地址分别作为VM B构造的ICMP报文的目的地址与源地址，之后，当执行回调函数got_packet的时候，需要在回调函数got_packet里面调用insert（）函数，下面是运行结果。</p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.3_3.PNG" srcset="/img/loading.gif" alt="task2.3_3"></p>
<p>现在VM A上面ping一个地址</p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.3_1.PNG" srcset="/img/loading.gif" alt="task2.3_1"></p>
<p>在VM B上编译运行sniff_and_spoof.c</p>
<p><img src="/2020/10/02/Web-Security-lab1/task2.3_2.PNG" srcset="/img/loading.gif" alt="task2.3_2"></p>
<p>之后在VM B上面运行wireshark抓包，可以看到有echo reply</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Packet-sniffing-and-spoofing-lab/">Packet sniffing and spoofing lab</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/10/09/Bufferr-Overflow-lab/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Bufferr_Overflow lab</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/09/8-9CTF%E4%B8%80%E5%91%A8%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">
                        <span class="hidden-mobile">8/9CTF一周学习总结</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Web_Security_lab1&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
